```{r}
source(here::here("src", "setup.R"), echo = FALSE)
```

<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# I. Data:
***

```{r}
(supplementary_data <- load_supplementary_data())

(clearing <- load_clearing_data())

clearing_responses <- c(
  "volume", "network_length", "surface_area", "segment_partitioning",
  "mean_segment_radius", "mean_segment_length", "mean_segment_tortuosity",
  "mean_segment_volume", "mean_segment_surface_area", "branchpoints",
  "endpoints", "number_of_segments"
)
```

**Temporary:**

```{r}
clearing_model <- function(data, resp_name, family = "Gamma") {
  
  form <- stringr::str_glue("{resp_name} ~ condition * level + offset(log(cerebellar_volume)) + (1 | mouse)")
  start_values <- list(beta = c(log(mean(data[[resp_name]])), rep(0, 3)))
  
  if (length(unique(data$level)) == 1) {
    form <- stringr::str_glue("{resp_name} ~ condition + offset(log(cerebellar_volume)) + (1 | mouse)")
    start_values <- list(beta = c(log(mean(data[[resp_name]])), rep(0, 1)))
  }
  
  mod_gamma <- purrr:::capture_output(
    glmmTMB(
      as.formula(form),
      family = list(family = family, link = "log"),
      data = data,
      start = start_values,
      REML = TRUE
    )
  )
  
  return(list(mod_gamma$result))
}

make_mod_params_plots <- function(data, vars, family, total_only = FALSE) {
  
  if (total_only) {
    data <- data |> filter(level == "Total")
  } else {
    data <- data |> filter(level != "Total")
  }
  
  purrr::map(
    vars,
    function(var) {
      models <- data |> 
        select(level, stage, condition, mouse, cerebellar_volume, any_of(var)) |>
        group_split(stage) |> 
        purrr::map_dfr(\(dat) dat |> 
            summarize(stage = first(stage), mod = clearing_model(pick(everything()), var, family), var_name = var) |> 
            select(-any_of(var))
        )
      
      params <- models |> 
        group_by(var_name, stage) |> 
        reframe(purrr::map_dfr(mod, parameters))
      
      perfs <- models |> 
        group_by(var_name, stage) |> 
        reframe(purrr::map_dfr(mod, performance))
      
      purrr::pwalk(
        models,
        \(var_name, stage, mod) make_signif_boxplot(mod, xaxis = "condition", subtitle = stage) |>
          save_png(stringr::str_glue("mod_{var_name}_clearing_{family}_{stage}{if (total_only) '_total' else ''}"), subfolder = "IHC", display = FALSE)
      )
      
      if (!total_only) {
        purrr::pwalk(
          models,
          \(var_name, stage, mod) make_signif_boxplot_inter(mod, pred1 = "condition", pred2 = "level") |>
            save_png(stringr::str_glue("mod_{var_name}_clearing_{family}_inter_{stage}"), subfolder = "IHC", display = FALSE)
        )
      }
      
      return(list(models = models, params = params, perfs = perfs))
    },
    .progress = TRUE
  )
}

gamma_resps <- c("volume", "network_length", "surface_area", "segment_partitioning", "mean_segment_radius", "mean_segment_length", "mean_segment_tortuosity", "mean_segment_volume", "mean_segment_surface_area")

negbin_resps <- c("branchpoints", "endpoints", "number_of_segments")

gamma_mods <- make_mod_params_plots(clearing$normal, gamma_resps, "Gamma")
nbinom_mods <- make_mod_params_plots(clearing$normal, negbin_resps, "nbinom2")

gamma_mods_total <- make_mod_params_plots(clearing$normal, gamma_resps, "Gamma", total_only = TRUE)
nbinom_mods_total <- make_mod_params_plots(clearing$normal, negbin_resps, "nbinom2", total_only = TRUE)
```

```{r}
fit_all_models <- function(data, vars, family, total_only = FALSE) { 
  
  if (total_only) {
    data <- data |> filter(level == "Total")
  } else {
    data <- data |> filter(level != "Total")
  }
   
  purrr::map_dfr(
    vars,
    function(var) {
      models <- data |>
        select(level, stage, condition, mouse, cerebellar_volume, any_of(var)) |>
        group_split(stage) |>
        purrr::map_dfr(\(dat) dat |>
            summarize(stage = first(stage), mod = clearing_model(pick(everything()), var, family), var_name = var) |>
            select(-any_of(var))
        )
      
      return(models)
    },
    .progress = TRUE
  )
}

gamma_resps <- c("volume", "network_length", "surface_area", "segment_partitioning", "mean_segment_radius", "mean_segment_length", "mean_segment_tortuosity", "mean_segment_volume", "mean_segment_surface_area")

negbin_resps <- c("branchpoints", "endpoints", "number_of_segments")

gamma_mods <- fit_all_models(clearing$normal, gamma_resps, "Gamma", total_only = TRUE)
nbinom_mods <- fit_all_models(clearing$normal, negbin_resps, "nbinom2", total_only = TRUE)

all_mods <- bind_rows(gamma_mods, nbinom_mods)
```

Temporary, to rework with facet_grid

```{r fig.height = 20, fig.width = 15}
fig_1 <- c("volume", "network_length", "surface_area")
fig_2 <- c("number_of_segments", "branchpoints", "segment_partitioning", "mean_segment_tortuosity")
fig_3 <- c("mean_segment_volume", "mean_segment_surface_area", "mean_segment_length", "mean_segment_radius")

all_mods |> 
  filter(var_name %in% fig_1) |>
  mutate(var_name = factor(var_name, levels = fig_1)) |> 
  group_by(var_name, stage) |> 
  group_map(function(d, g) make_signif_boxplot(first(d$mod), xaxis = "condition")) |> 
  patchwork::wrap_plots(ncol = 4, axes = "collect") |> 
  save_png("fig_patchwork_1", subfolder = "IHC", width = 18, height = 15, display = TRUE)

all_mods |> 
  filter(var_name %in% fig_2) |>
  mutate(var_name = factor(var_name, levels = fig_2)) |> 
  group_by(var_name, stage) |> 
  group_map(function(d, g) make_signif_boxplot(first(d$mod), xaxis = "condition")) |> 
  patchwork::wrap_plots(ncol = 4, axes = "collect") |> 
  save_png("fig_patchwork_2", subfolder = "IHC", width = 18, height = 20, display = TRUE)

all_mods |> 
  filter(var_name %in% fig_3) |>
  mutate(var_name = factor(var_name, levels = fig_3)) |> 
  group_by(var_name, stage) |> 
  group_map(function(d, g) make_signif_boxplot(first(d$mod), xaxis = "condition")) |> 
  patchwork::wrap_plots(ncol = 4, axes = "collect") |> 
  save_png("fig_patchwork_3", subfolder = "IHC", width = 18, height = 20, display = TRUE)
```


<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
# II. Total
***

```{r}
clearing_total <- clearing$normal |> filter(level == "Total")
clearing_binned_total <- clearing$binned |> filter(level == "Total")
```

<!----------------------------------------------------------------------------->
## 1. Volume
***

<!----------------------------------------------------------------------------->
### Models

**Gamma**

```{r}
mod_vol_gamma_tot <- glmmTMB(
  volume ~ condition * stage + offset(log(cerebellar_volume)) + (1 | mouse),
  family = Gamma("log"),
  data = clearing_total,
  REML = TRUE
)

cli_h1("[Parameters]")
parameters(mod_vol_gamma_tot)
cli_h1("[Fitness]")
performance(mod_vol_gamma_tot)
```

<!----------------------------------------------------------------------------->
### Model Diagnostics

#### Residual diagnostics

```{r fig.width = 10}
check_model(mod_vol_gamma_tot)

make_acf_plot(mod_vol_gamma_tot)
```

#### Predictive checks

```{r}
mod_vol_gamma_tot_dharma <- DHARMa::simulateResiduals(mod_vol_gamma_tot, plot = FALSE, n = 300, seed = getOption("seed"))
mod_vol_gamma_tot_dharma_t <- t(mod_vol_gamma_tot_dharma$simulatedResponse)
```

```{r fig.width = 10}
ppc_plots(mod_vol_gamma_tot, simulations = mod_vol_gamma_tot_dharma_t, term = "condition")
ppc_plots(mod_vol_gamma_tot, simulations = mod_vol_gamma_tot_dharma_t, term = "stage")
```

```{r fig.width = 10}
ppc_stat_plots(mod_vol_gamma_tot, simulations = mod_vol_gamma_tot_dharma_t, term = "condition")
ppc_stat_plots(mod_vol_gamma_tot, simulations = mod_vol_gamma_tot_dharma_t, term = "stage")
```

#### Potential outliers

```{r}
get_model_based_outliers(clearing_total, mod_vol_gamma_tot, mod_vol_gamma_tot_dharma, clearing_responses)
```

<!----------------------------------------------------------------------------->
### Model Analysis

#### Model parameters

**All effects (Wald):**

```{r}
parameters(
  mod_vol_gamma_tot, exponentiate = should_exp(mod_vol_gamma_tot),
  ci_method = "Wald", p_adjust = "none", summary = TRUE, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_vol_gamma_tot, type = 3)
```

#### Marginal means

**Condition**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_tot), dvs = find_response(mod_vol_gamma_tot), between = "condition")

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_tot, specs = "condition", type = "response")
```

**Stage**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_tot), dvs = find_response(mod_vol_gamma_tot), between = "stage")

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_tot, specs = "stage", type = "response")
```

**Condition:Stage**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_tot), dvs = find_response(mod_vol_gamma_tot), between = c("condition", "stage"))

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_tot, specs = ~ condition | stage, type = "response")
```

#### Contrasts

**Condition**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_tot, specs = "condition", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_tot, specs = "condition", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_vol_gamma_tot, xaxis = "condition")
```

**Stage**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_tot, specs = "stage", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_tot, specs = "stage", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_vol_gamma_tot, xaxis = "stage")
```

**Condition:Stage**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_tot, specs = ~ condition | stage, type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h2("[Interaction]")

emmeans(mod_vol_gamma_tot, specs = ~ condition | stage, type = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_tot, specs = ~ condition | stage, regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h2("[Interaction]")

emmeans(mod_vol_gamma_tot, specs = ~ condition | stage, regrid = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE)
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_vol_gamma_tot, xaxis = "condition", facet = "stage", ncol = 4) |> 
  save_png("mod_vol_gamma_tot", subfolder = "IHC", width = 14, height = 6, display = TRUE)
```

<!----------------------------------------------------------------------------->
## 2. Network length
***

TODO


<!----------------------------------------------------------------------------->
## 12. Number of segments
***

<!----------------------------------------------------------------------------->
### Models

**Negative Binomial**

```{r}
mod_numseg_nbinom_tot <- glmmTMB(
  number_of_segments ~ condition * stage + offset(log(cerebellar_volume)) + (1 | mouse),
  family = nbinom1("log"),
  data = clearing_total,
  REML = TRUE
)

cli_h1("[Parameters]")
parameters(mod_numseg_nbinom_tot)
cli_h1("[Fitness]")
performance(mod_numseg_nbinom_tot)
cli_h1("[Dispersion]")
check_overdispersion(mod_numseg_nbinom_tot)
```

<!----------------------------------------------------------------------------->
### Model Diagnostics

#### Residual diagnostics

```{r fig.width = 10}
check_model(mod_numseg_nbinom_tot)

make_acf_plot(mod_numseg_nbinom_tot)
```

#### Predictive checks

```{r}
mod_numseg_nbinom_tot_dharma <- DHARMa::simulateResiduals(mod_numseg_nbinom_tot, plot = FALSE, n = 300, seed = getOption("seed"))
mod_numseg_nbinom_tot_dharma_t <- t(mod_numseg_nbinom_tot_dharma$simulatedResponse)
```

```{r fig.width = 10}
# ppc_plots(mod_numseg_nbinom_tot, simulations = mod_numseg_nbinom_tot_dharma_t, term = "condition")
# ppc_plots(mod_numseg_nbinom_tot, simulations = mod_numseg_nbinom_tot_dharma_t, term = "stage")
```

```{r fig.width = 10}
# ppc_stat_plots(mod_numseg_nbinom_tot, simulations = mod_numseg_nbinom_tot_dharma_t, term = "condition")
# ppc_stat_plots(mod_numseg_nbinom_tot, simulations = mod_numseg_nbinom_tot_dharma_t, term = "stage")
```

#### Potential outliers

```{r}
get_model_based_outliers(clearing_total, mod_numseg_nbinom_tot, mod_numseg_nbinom_tot_dharma, clearing_responses)
```

<!----------------------------------------------------------------------------->
### Model Analysis

#### Model parameters

**All effects (Wald):**

```{r}
parameters(
  mod_numseg_nbinom_tot, exponentiate = should_exp(mod_numseg_nbinom_tot),
  ci_method = "Wald", p_adjust = "none", summary = TRUE, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_numseg_nbinom_tot, type = 3)
```

#### Marginal means

**Condition**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_numseg_nbinom_tot), dvs = find_response(mod_numseg_nbinom_tot), between = "condition")

cli_h1("[Emmeans]")

emmeans(mod_numseg_nbinom_tot, specs = "condition", type = "response")
```

**Stage**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_numseg_nbinom_tot), dvs = find_response(mod_numseg_nbinom_tot), between = "stage")

cli_h1("[Emmeans]")

emmeans(mod_numseg_nbinom_tot, specs = "stage", type = "response")
```

**Condition:Stage**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_numseg_nbinom_tot), dvs = find_response(mod_numseg_nbinom_tot), between = c("condition", "stage"))

cli_h1("[Emmeans]")

emmeans(mod_numseg_nbinom_tot, specs = ~ condition | stage, type = "response")
```

#### Contrasts

**Condition**

```{r}
cli_h1("[Link scale]")

emmeans(mod_numseg_nbinom_tot, specs = "condition", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_numseg_nbinom_tot, specs = "condition", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_numseg_nbinom_tot, xaxis = "condition")
```

**Stage**

```{r}
cli_h1("[Link scale]")

emmeans(mod_numseg_nbinom_tot, specs = "stage", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_numseg_nbinom_tot, specs = "stage", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_numseg_nbinom_tot, xaxis = "stage")
```

**Condition:Stage**

```{r}
cli_h1("[Link scale]")

emmeans(mod_numseg_nbinom_tot, specs = ~ condition | stage, type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h2("[Interaction]")

emmeans(mod_numseg_nbinom_tot, specs = ~ condition | stage, type = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_numseg_nbinom_tot, specs = ~ condition | stage, regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h2("[Interaction]")

emmeans(mod_numseg_nbinom_tot, specs = ~ condition | stage, regrid = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE)
```

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_numseg_nbinom_tot, xaxis = "condition", facet = "stage", ncol = 4) |> 
  save_png("mod_numseg_nbinom_tot", subfolder = "IHC", width = 14, height = 6, display = TRUE)
```

<!----------------------------------------------------------------------------->
<!----------------------------------------------------------------------------->
## III. Deep vs Superficial
***

```{r}
clearing_ds <- clearing$normal |> filter(level != "Total")
clearing_binned_ds <- clearing$binned |> filter(level != "Total")
```

<!----------------------------------------------------------------------------->
## 1. Volume
***

### Models

```{r}
mod_vol_gamma_ds <- glmmTMB(
  volume ~ condition * stage * level + offset(log(cerebellar_volume)) + (1 | mouse),
  family = Gamma("log"),
  data = clearing_ds,
  REML = TRUE
)

cli_h1("[Parameters]")
parameters(mod_vol_gamma_ds)
cli_h1("[Fitness]")
performance(mod_vol_gamma_ds)
```


<!----------------------------------------------------------------------------->
### Model Diagnostics

#### Residual diagnostics

```{r fig.width = 10}
check_model(mod_vol_gamma_ds)

make_acf_plot(mod_vol_gamma_ds)
```

#### Predictive checks

```{r}
mod_vol_gamma_ds_dharma <- DHARMa::simulateResiduals(mod_vol_gamma_ds, plot = FALSE, n = 300, seed = getOption("seed"))
mod_vol_gamma_ds_dharma_t <- t(mod_vol_gamma_ds_dharma$simulatedResponse)
```

```{r fig.width = 10}
ppc_plots(mod_vol_gamma_ds, simulations = mod_vol_gamma_ds_dharma_t, term = "condition")
ppc_plots(mod_vol_gamma_ds, simulations = mod_vol_gamma_ds_dharma_t, term = "stage")
ppc_plots(mod_vol_gamma_ds, simulations = mod_vol_gamma_ds_dharma_t, term = "level")
```

```{r fig.width = 10}
ppc_stat_plots(mod_vol_gamma_ds, simulations = mod_vol_gamma_ds_dharma_t, term = "condition")
ppc_stat_plots(mod_vol_gamma_ds, simulations = mod_vol_gamma_ds_dharma_t, term = "stage")
ppc_stat_plots(mod_vol_gamma_ds, simulations = mod_vol_gamma_ds_dharma_t, term = "level")
```

#### Potential outliers

```{r}
get_model_based_outliers(clearing_total, mod_vol_gamma_ds, mod_vol_gamma_ds_dharma, clearing_responses)
```

<!----------------------------------------------------------------------------->
### Model Analysis

#### Model parameters

**All effects (Wald):**

```{r}
parameters(
  mod_vol_gamma_ds, exponentiate = should_exp(mod_vol_gamma_ds),
  ci_method = "Wald", p_adjust = "none", summary = TRUE, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_vol_gamma_ds, type = 3)
```

#### Marginal means

**Condition**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_ds), dvs = find_response(mod_vol_gamma_ds), between = "condition")

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_ds, specs = "condition", type = "response")
```

**Stage**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_ds), dvs = find_response(mod_vol_gamma_ds), between = "stage")

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_ds, specs = "stage", type = "response")
```

**Level**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_ds), dvs = find_response(mod_vol_gamma_ds), between = "level")

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_ds, specs = "level", type = "response")
```

**Condition:Stage**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_ds), dvs = find_response(mod_vol_gamma_ds), between = c("condition", "stage"))

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_ds, specs = ~ condition | stage, type = "response")
```

**Condition:Level**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_ds), dvs = find_response(mod_vol_gamma_ds), between = c("condition", "level"))

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_ds, specs = ~ condition | level, type = "response")
```

**Condition:Stage:Level**

```{r}
cli_h1("[Observed]")

distribution_summary(get_data(mod_vol_gamma_ds), dvs = find_response(mod_vol_gamma_ds), between = c("condition", "stage", "level"))

cli_h1("[Emmeans]")

emmeans(mod_vol_gamma_ds, specs = ~ condition * stage * level, type = "response")
```

#### Contrasts

**Condition**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_ds, specs = "condition", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_ds, specs = "condition", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_vol_gamma_ds, xaxis = "condition")
```

**Stage**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_ds, specs = "stage", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_ds, specs = "stage", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_vol_gamma_ds, xaxis = "stage")
```

**Level**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_ds, specs = "level", type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_ds, specs = "level", regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

```{r fig.width = 4, fig.height = 7}
make_signif_boxplot(mod_vol_gamma_ds, xaxis = "level")
```

**Condition * Level |Stage**

```{r}
cli_h1("[Link scale]")

emmeans(mod_vol_gamma_ds, specs = ~ condition * level | stage, type = "response") |> 
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h2("[Interaction]")

emmeans(mod_vol_gamma_ds, specs = ~ condition * level | stage, type = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE)

cli_h1("[Response scale]")

emmeans(mod_vol_gamma_ds, specs = ~ condition * level | stage, regrid = "response") |>
  contrast(method = "pairwise", adjust = "none", infer = TRUE)

cli_h2("[Interaction]")

emmeans(mod_vol_gamma_ds, specs = ~ condition * level | stage, regrid = "response") |>
  contrast(interaction = "pairwise", by = NULL, adjust = "none", infer = TRUE)
```

Levels combined:

```{r fig.width = 14, fig.height = 6}
make_signif_boxplot(mod_vol_gamma_ds, xaxis = "condition", facet = "stage", ncol = 4) |> 
  save_png("mod_vol_gamma_ds", subfolder = "IHC", width = 14, height = 6)
```

Levels separated:

```{r}
make_signif_boxplot_inter(mod_vol_gamma_ds, pred1 = "condition", pred2 = "level", facet = "stage", ncol = 4)
  save_png("mod_vol_gamma_ds_inter", subfolder = "IHC", width = 14, height = 6)
```
