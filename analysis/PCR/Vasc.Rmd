```{r}
source(here::here("src", "setup.R"), echo = FALSE)
```

<!---------------------------------------------------------->
<!---------------------------------------------------------->
# I. Data
***

```{r}
(supplementary_data <- load_supplementary_data())
```

```{r}
(vasc_data <- load_pcr_data(target = "vasc", reprocess = TRUE))
```

<!---------------------------------------------------------->
<!---------------------------------------------------------->
# II. Model fitting
***

Let's define the model we will fit to each `Gene`'s `DCq` data. 

Here, we will fit a simple Linear Model, which is largely similar to running a t-test between both conditions:

```{r}
vasc_model <- function(data) {
  glmmTMB(dcq ~ condition, family = gaussian("identity"), data = data, contrasts = list(condition = "contr.sum"))
}
```

Now, let's fit said model to each `Gene`'s data, for a given `Stage` and `Layer`:

```{r}
compute_fold_change <- function(mod) {
  return(
    get_data(mod)
    |> select(condition, dcq)
    |> pivot_wider(names_from = condition, values_from = dcq, values_fn = mean)
    |> summarize(fold = 2**(-1 * (IH - N)))
    |> pull(fold)
  )
}
```

```{r}
(vasc_data$models <- vasc_data$clean
  |> group_split(stage, gene)
  |> map_dfr(
    \(d) summarize(d, mod = pick(condition, dcq) |> vasc_model() |> list(), .by = c(stage, gene)), 
    .progress = "Fitting models:"
  )
  |> filter(!has_na_coefs(mod)) # Removing models that did not fit properly
  |> mutate(fold = map_dbl(mod, compute_fold_change)) # Adding the Fold change
  |> select(stage, gene, fold, mod)
)
```

<!---------------------------------------------------------->
<!---------------------------------------------------------->
# III. Model analysis
***

## Predictions

For each model we fit, we can then extract the CI and p_value for the relevant contrasts, and use those to establish if a `Gene` was up or down-regulated:

```{r}
get_emmeans_data <- function(mod) {
  return(
    emmeans(mod, specs = "condition", type = "response")
    |> contrast(method = "pairwise", adjust = "none", infer = TRUE)
    |> as.data.frame()
    |> pivot_wider(names_from = contrast, values_from = estimate)
    |> select(last_col(), LCB = lower.CL, UCB = upper.CL, p_value = p.value)
    |> mutate(across(where(is.character), \(x) na_if(x, "NaN")))
  )
}
```

```{r}
(vasc_data$predictions <- vasc_data$models
  |> group_split(stage, gene)
  |> map_dfr(\(d) mutate(d, get_emmeans_data(mod[[1]])), .progress = "Extracting model predictions:")
  |> filter(!is.na(p_value))
  |> mutate(expression = get_regulation_type(fold, p_value))
  |> select(stage, gene, fold, expression, matches("-|/"), LCB, UCB, p_value)
)
```

## Gene regulation timeline

To get a better idea of how each `Gene`'s regulation changes through time, we can plot a timeline of their expression, split by `Layer` and `Pathway`.

```{r fig.width = 12, fig.height = 8}
(
  vasc_data$predictions 
  |> left_join(supplementary_data$gene_data$ref, join_by(gene))
  |> filter(p_value <= .05)
  |> select(stage, gene, fold, p_value, expression, pathway, effect)
  |> mutate(effect = case_when(
      str_detect(expression, "Downregulated") & effect == "Pro" ~ "Anti",
      str_detect(expression, "Downregulated") & effect == "Anti" ~ "Pro",
      .default = effect
    )
  )
  |> make_fold_timeline_plot(facet_rows = "pathway", color_by = "effect", size_boost = 1.5)
  |> save_png("vasc_timeline", subfolder = "PCR")
)
```

## Temporo-functional heatmap

```{r}
vasc_data$predictions |>
  filter(p_value <= .05) |>
  left_join(supplementary_data$gene_data$fx, by = "gene", relationship = "many-to-many") |>
  select(stage, gene, fold, p_value, fx, effect) |> 
  make_heatmap(xaxis = "fx", facet = "stage") |> 
  save_png("vasc_heatmap", subfolder = "PCR", height = 10, width = 15)
```

# Weird figure

```{r fig.width = 20, fig.height = 14}
colors <- c(
      "Vascular stabilization and maturation" = "#fc6203",
      "ECM and endothelial permeability" = "#026dba",
      "Endothelial proliferation and survival" = "#ba028c",
      "Vascular invasion and sprouting" = "#02ba11",
      "Vascular remodelling and patterning" = "#9004d6",
      "Hypoxia-induced angiogenesis" = "#fc0341"
    )

(
  vasc_data$predictions |>
    filter(p_value <= .05) |>
    left_join(supplementary_data$gene_data$fx, by = "gene", relationship = "many-to-many") |>
    select(stage, gene, fold, p_value, fx, effect) |> 
    ggplot(aes(x = stage, y = fold, color = fx, shape = effect)) 
  + geom_hline(yintercept = 1, linetype = "dashed") 
  + geom_vline(
    aes(xintercept = as.numeric(factor(stage)) - 0.5), 
    linetype = "dashed", color = "gray70"
  )
  + geom_point(
      size = 3, 
      position = position_dodge(width = 0.9)
    ) 
  + geom_text(
      aes(
        label = paste(gene, stars_pval(p_value)),
        vjust = ifelse(effect == "positive", 1.7, -0.7)
      ),
      hjust = 0.4,
      size = 3,
      position = position_dodge(width  = 0.9)
    ) 
  + scale_shape_manual(values = c("negative" = 25, "positive" = 24)) 
  + scale_color_manual(values = c(
      "Vascular stabilization and maturation" = "#fc6203",
      "ECM and endothelial permeability" = "#026dba",
      "Endothelial proliferation and survival" = "#ba028c",
      "Vascular invasion and sprouting" = "#02ba11",
      "Vascular remodelling and patterning" = "#9004d6",
      "Hypoxia-induced angiogenesis" = "#fc0341"
    )) 
  + theme_minimal() 
  + theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = "bottom",
    legend.text = element_text(size = 12, vjust = 0.5),
    legend.box = "vertical",
    legend.title = element_text(face = "bold"),
    legend.margin = margin(t = 10, b = 10)
  )
  + guides(
    colour = guide_legend(override.aes = list(alpha = 1), order = 1, title = "Function"),
    shape = guide_legend(override.aes = list(alpha = 1), order = 2, title = "Effect")
  )
) |> save_png("vasc_timeline_2", subfolder = "PCR", width = 20, height = 14, display = TRUE)
```

Using text only:

```{r}
# Up: \u25B2
# Down: \u25BC

(
  vasc_data$predictions |>
  filter(p_value <= .05) |>
  left_join(supplementary_data$gene_data$fx, by = "gene", relationship = "many-to-many") |>
  select(stage, gene, fold, p_value, fx, effect) |> 
  mutate(
    label = case_when(
      effect == "positive" ~ paste0("\u25B2 ", gene, stars_pval(p_value)),
      effect == "negative" ~ paste0("\u25BC ", gene, stars_pval(p_value)),
      .default = paste0(gene, stars_pval(p_value))
    )
  )
  |> ggplot(aes(x = fx, y = fold, color = fx, shape = effect))
  + geom_hline(yintercept = 1, linetype = "dashed")
  + geom_point(alpha = 0, size = 3, show.legend = TRUE)
  + geom_text_repel(
      aes(label = label),
      max.overlaps = 50,
      min.segment.length = Inf,
      direction = "x",
      force = 2,
      point.size = NA,
      seed = 47,
      show.legend = FALSE
    )
  + facet_wrap(~ stage, ncol = 5, strip.position = "bottom")
  + scale_shape_manual(values = c("negative" = 25, "positive" = 24)) 
  + scale_color_manual(values = colors) 
  + labs(y = "Fold Change", x = NULL) 
  + theme_minimal() 
  + theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = "bottom",
    legend.text = element_text(size = 12, vjust = 0.5),
    legend.box = "vertical",
    legend.title = element_text(face = "bold"),
    legend.margin = margin(t = 10, b = 10),
    strip.placement = "outside",
    strip.background = element_blank(),
    strip.text = element_text(face = "bold"),
    panel.margin = margin(t = 0, r = 0, b = 0, l = 0)
  )
  + guides(
    colour = guide_legend(override.aes = list(alpha = 1), order = 1, title = "Function"),
    shape = guide_legend(override.aes = list(alpha = 1), order = 2, title = "Effect")
  )
) |> save_png("vasc_timeline_4", subfolder = "PCR", width = 20, height = 14, display = TRUE)
```
